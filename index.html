<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOWV1RE - Магазин игровых услуг</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #0a0a0a;
    --bg-secondary: #121212;
    --bg-tertiary: #1e1e23;
    --border-color: #2a2a2f;
    --text-primary: #ffffff;
    --text-secondary: #b0b0b0;
    --accent-blue: #4A90E2;
}

body.light-theme {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e8e8e8;
    --border-color: #d0d0d0;
    --text-primary: #000000;
    --text-secondary: #666666;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
}

/* Header */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--bg-tertiary);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    backdrop-filter: blur(10px);
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

.nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
}

.logo {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent-blue);
    text-decoration: none;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: -10px;
}

.logo:hover {
    color: #5ba3f5;
}

.nav-links {
    display: flex;
    gap: 40px;
    align-items: center;
}

.nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    font-size: 15px;
    transition: color 0.3s;
}

.nav-links a:hover {
    color: var(--text-primary);
}

.lang-switch {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.lang-switch:hover {
    background: var(--border-color);
    color: var(--text-primary);
}

/* Currency switcher */
.currency-switch {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.currency-switch:hover {
    background: var(--border-color);
    color: var(--text-primary);
}

/* Theme toggle */
.theme-toggle {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 38px;
}

.theme-toggle:hover {
    background: var(--border-color);
    transform: rotate(15deg);
}

.controls-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* Mobile menu button */
.mobile-menu-btn {
    display: none;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 24px;
    color: var(--text-primary);
    transition: all 0.3s;
}

.mobile-menu-btn:hover {
    background: var(--border-color);
}

/* Mobile menu overlay */
.mobile-menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 9998;
}

.mobile-menu-overlay.active {
    display: block;
}

/* Mobile menu panel */
.mobile-menu {
    display: none;
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: 100%;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border-color);
    z-index: 9999;
    padding: 80px 24px 24px;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.mobile-menu.active {
    right: 0;
}

.mobile-menu-close {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 32px;
    color: var(--text-secondary);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

.mobile-menu-item {
    margin-bottom: 24px;
}

.mobile-menu-label {
    display: block;
    color: var(--text-secondary);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.mobile-menu .currency-switch,
.mobile-menu .lang-switch,
.mobile-menu .theme-toggle {
    width: 100%;
    text-align: left;
}

@media (max-width: 768px) {
    .nav-links {
        display: none;
    }
    
    .mobile-menu-btn {
        display: block;
    }
    
    .mobile-menu {
        display: block;
    }
}

/* Hero Section */
.hero {
    padding: 100px 20px;
    text-align: center;
    background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
}

.hero h1 {
    font-size: 56px;
    font-weight: 800;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--accent-blue), #7B68EE);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero p {
    font-size: 20px;
    color: var(--text-secondary);
    margin-bottom: 40px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.cta-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    padding: 14px 32px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, var(--accent-blue), #667eea);
    color: #ffffff;
    box-shadow: 0 4px 20px rgba(74, 144, 226, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(74, 144, 226, 0.4);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
    border-color: var(--accent-blue);
}

/* Games Section */
.games-section {
    padding: 80px 20px;
}

.section-title {
    font-size: 36px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 50px;
}

/* Game Search */
.game-search-container {
    max-width: 600px;
    margin: 0 auto 40px;
    position: relative;
}

.game-search-input {
    width: 100%;
    padding: 16px 50px 16px 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--bg-tertiary);
    border-radius: 16px;
    color: var(--text-primary);
    font-size: 16px;
    transition: all 0.3s;
}

.game-search-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
}

.game-search-input::placeholder {
    color: var(--text-secondary);
}

.game-search-icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--text-secondary);
    pointer-events: none;
}

.no-results {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
    font-size: 18px;
}

.no-results-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.games-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

@media (max-width: 1200px) {
    .games-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .games-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .games-grid {
        grid-template-columns: 1fr;
    }
}

.game-card {
    background: var(--bg-secondary);
    border: 1px solid var(--bg-tertiary);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s;
    cursor: pointer;
}

.game-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-blue);
    box-shadow: 0 8px 32px rgba(74, 144, 226, 0.15);
}

.game-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 20px;
    position: relative;
}

.game-icon::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 15px;
    background: var(--accent-blue);
    filter: blur(12px);
    opacity: 0.6;
    border-radius: 50%;
}

.game-card h3 {
    font-size: 22px;
    margin-bottom: 10px;
    color: #ffffff;
}

.game-card p {
    color: #b0b0b0;
    font-size: 14px;
    margin-bottom: 16px;
}

.game-price {
    margin-bottom: 16px;
}

.price-display {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent-blue);
    display: inline-block;
}

.price-tag {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
}

.price {
    font-size: 18px;
    font-weight: 700;
    color: #4A90E2;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--bg-tertiary);
    border-radius: 20px;
    max-width: 480px;
    width: 100%;
    padding: 40px;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 28px;
    color: #666;
    cursor: pointer;
    transition: color 0.3s;
    background: none;
    border: none;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: #ffffff;
}

.modal-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 30px;
    text-align: center;
    color: #ffffff;
}

.modal-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    background: #0a0a0a;
    padding: 6px;
    border-radius: 12px;
}

.tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    color: #b0b0b0;
}

.tab.active {
    background: #1e1e23;
    color: #ffffff;
}

/* Form */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 14px;
}

.form-group input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.3s;
}

.form-group input:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.form-group input.error {
    border-color: #FF4757;
}

.form-submit {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent-blue), #667eea);
    border: none;
    border-radius: 10px;
    color: #ffffff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
}

.form-submit:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
}

.form-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.form-switch {
    text-align: center;
    margin-top: 20px;
    color: var(--text-secondary);
    font-size: 14px;
}

.form-switch a {
    color: var(--accent-blue);
    text-decoration: none;
    cursor: pointer;
    font-weight: 600;
}

.form-switch a:hover {
    text-decoration: underline;
}

/* Google Auth Button */
.google-btn {
    width: 100%;
    padding: 14px;
    background: white;
    color: #444;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 16px;
}

.google-btn:hover {
    background: #f8f8f8;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.google-icon {
    width: 20px;
    height: 20px;
}

.divider {
    display: flex;
    align-items: center;
    text-align: center;
    margin: 24px 0 16px;
    color: var(--text-secondary);
    font-size: 14px;
}

.divider::before,
.divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.divider::before {
    margin-right: 16px;
}

.divider::after {
    margin-left: 16px;
}

/* Messages */
.error-msg, .success-msg {
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 500;
}

.error-msg {
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid rgba(255, 71, 87, 0.3);
    color: #FF4757;
}

.success-msg {
    background: rgba(0, 210, 106, 0.1);
    border: 1px solid rgba(0, 210, 106, 0.3);
    color: #00D26A;
}

/* Loading */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Profile */
.profile-container {
    max-width: 800px;
    margin: 60px auto;
    padding: 0 20px;
}

.profile-section {
    background: var(--bg-secondary);
    border: 1px solid var(--bg-tertiary);
    border-radius: 24px;
    padding: 48px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 40px;
    padding-bottom: 40px;
    border-bottom: 1px solid var(--bg-tertiary);
}

.profile-avatar {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, var(--accent-blue), #7B68EE);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}

.profile-info {
    flex: 1;
}

.profile-info h2 {
    font-size: 32px;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.profile-info p {
    color: var(--text-secondary);
    font-size: 16px;
    margin: 4px 0;
}

.profile-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 32px;
}

.stat-box {
    background: var(--bg-tertiary);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    transition: transform 0.3s;
}

.stat-box:hover {
    transform: translateY(-4px);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    color: var(--accent-blue);
    font-size: 24px;
    font-weight: 700;
}

.logout-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

@media (max-width: 768px) {
    .profile-section {
        padding: 32px 24px;
    }
    
    .profile-header {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-stats {
        grid-template-columns: 1fr;
    }
}

/* User info in header */
.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.user-info:hover {
    background: var(--border-color);
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent-blue), #7B68EE);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    color: white;
}

.user-name {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}

.auth-btn {
    padding: 8px 20px;
    background: linear-gradient(135deg, var(--accent-blue), #7B68EE);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
}

.balance-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    padding: 24px 32px;
    border-radius: 16px;
    text-align: center;
}

.balance-card p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    margin-bottom: 8px;
}

.balance-card h3 {
    font-size: 36px;
    font-weight: 700;
}

/* Footer / Contact Section */
.footer {
    max-width: 800px;
    margin: 80px auto 40px;
    padding: 48px;
    background: var(--bg-secondary);
    border: 1px solid var(--bg-tertiary);
    border-radius: 24px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.footer h3 {
    font-size: 32px;
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--accent-blue), #7B68EE);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.footer p {
    color: var(--text-secondary);
    font-size: 16px;
    margin-bottom: 32px;
}

.contact {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
}

.contact a {
    padding: 14px 28px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.contact a:hover {
    background: var(--accent-blue);
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(74, 144, 226, 0.3);
}

@media (max-width: 768px) {
    .footer {
        padding: 32px 24px;
        margin: 60px 20px 40px;
    }
    
    .footer h3 {
        font-size: 24px;
    }
    
    .contact {
        flex-direction: column;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .hero h1 {
        font-size: 36px;
    }
    
    .hero p {
        font-size: 16px;
    }
    
    .nav-links {
        display: none;
    }
    
    .games-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        padding: 30px 20px;
    }
}
</style>
</head>
<body>
<div class="content-wrapper">
<div class="header" id="header">
<div class="container">
<div class="nav">
<a href="#" class="logo" onclick="window.location.reload()">🎮 LOWV1RE</a>
<div class="nav-links">
<a href="#games" data-lang-text="Игры|Games">Игры</a>
<a href="#services" data-lang-text="Услуги|Services">Услуги</a>
<a href="#contact" data-lang-text="Контакты|Contact">Контакты</a>
<div id="authSection"></div>
<div class="controls-group">
<select class="currency-switch" id="currencySwitch">
<option value="RUB">₽ RUB</option>
<option value="USD">$ USD</option>
<option value="EUR">€ EUR</option>
</select>
<button class="theme-toggle" id="themeToggle" title="Toggle theme">🌙</button>
<div class="lang-switch" id="langSwitch">RU</div>
</div>
</div>
<button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">☰</button>
</div>
</div>
</div>

<!-- Mobile Menu -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
<div class="mobile-menu" id="mobileMenu">
<button class="mobile-menu-close" onclick="closeMobileMenu()">×</button>

<div class="mobile-menu-item">
<div class="mobile-menu-label" data-lang-text="Валюта|Currency">Валюта</div>
<select class="currency-switch" id="currencySwitchMobile" onchange="changeCurrency()">
<option value="RUB">₽ RUB</option>
<option value="USD">$ USD</option>
<option value="EUR">€ EUR</option>
</select>
</div>

<div class="mobile-menu-item">
<div class="mobile-menu-label" data-lang-text="Тема|Theme">Тема</div>
<button class="theme-toggle" id="themeToggleMobile" style="width:100%;justify-content:center;" onclick="toggleTheme()" title="Toggle theme">🌙</button>
</div>

<div class="mobile-menu-item">
<div class="mobile-menu-label" data-lang-text="Язык|Language">Язык</div>
<div class="lang-switch" id="langSwitchMobile" style="width:100%;justify-content:center;cursor:pointer;">RU</div>
</div>

<div class="mobile-menu-item" style="margin-top:32px;">
<div id="authSectionMobile"></div>
</div>
</div>

<div class="hero">
<div class="container">
<h1 id="heroTitle" data-lang-text="LOWV1RE MARKET|LOWV1RE MARKET">LOWV1RE MARKET</h1>
<p id="heroDesc" data-lang-text="Донат. Аккаунты. Прокачка. Всё под твоим контролем.|Donations. Accounts. Boosting. Everything under your control.">Донат. Аккаунты. Прокачка. Всё под твоим контролем.</p>
<div class="cta-buttons" id="heroButtons">
<button class="btn btn-primary" onclick="openModal('loginModal')" data-lang-text="Войти|Login">Войти</button>
<button class="btn btn-secondary" onclick="openModal('registerModal')" data-lang-text="Регистрация|Register">Регистрация</button>
</div>
</div>
</div>

<div id="profileSection" style="display:none;">
<div class="container">
<div class="profile-section">
<div class="profile-header">
<div class="profile-avatar" id="profileAvatar">U</div>
<div class="profile-info">
<h2 id="profileUsername">Username</h2>
<p id="profileEmail">email@example.com</p>
<p id="profileUrl" style="color:#ff8c00; margin-top:5px; font-size:16px;">lowv1re.eu/user1</p>
</div>
</div>
<div class="profile-stats">
<div class="stat-box">
<div class="stat-label" data-lang-text="Баланс|Balance">Баланс</div>
<div class="stat-value" id="profileBalance">0₽</div>
</div>
<div class="stat-box">
<div class="stat-label" data-lang-text="Заказов|Orders">Заказов</div>
<div class="stat-value" id="profileOrders">0</div>
</div>
<div class="stat-box">
<div class="stat-label" data-lang-text="Дата регистрации|Registered">Дата регистрации</div>
<div class="stat-value" id="profileDate" style="font-size:14px;">--</div>
</div>
</div>
<button class="logout-btn" onclick="logout()" data-lang-text="Выйти|Logout">Выйти</button>
</div>
</div>
</div>

<div class="container" id="games">
<h2 class="section-title" data-lang-text="🎮 Популярные игры|🎮 Popular Games">🎮 Популярные игры</h2>

<div class="game-search-container">
<input 
    type="text" 
    id="gameSearchInput" 
    class="game-search-input" 
    placeholder="Поиск игры..."
    data-lang-placeholder="Поиск игры...|Search game..."
    oninput="searchGames()"
>
<span class="game-search-icon">🔍</span>
</div>

<div class="games-grid" id="gamesGrid">

<div class="game-card card-apex" data-price="180">
<div>
<div class="game-icon">🎯</div>
<h3 data-lang-text="Apex Legends|Apex Legends">Apex Legends</h3>
<p data-lang-text="Apex монеты, легенды, батл-пасс|Apex Coins, legends, battle pass">Apex монеты, легенды, батл-пасс</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 180₽</span>
</div>
<button class="btn" onclick="buyProduct('Apex Legends', 180)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-brawl" data-price="100">
<div>
<div class="game-icon">⭐</div>
<h3 data-lang-text="Brawl Stars|Brawl Stars">Brawl Stars</h3>
<p data-lang-text="Гемы, аккаунты, прокачка персонажей|Gems, accounts, character boost">Гемы, аккаунты, прокачка персонажей</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 100₽</span>
</div>
<button class="btn" onclick="buyProduct('Brawl Stars', 100)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-cod" data-price="280">
<div>
<div class="game-icon">🎖️</div>
<h3 data-lang-text="Call of Duty|Call of Duty">Call of Duty</h3>
<p data-lang-text="COD Points, скины оружия, батл-пасс|COD Points, weapon skins, battle pass">COD Points, скины оружия, батл-пасс</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 280₽</span>
</div>
<button class="btn" onclick="buyProduct('Call of Duty', 280)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-clash" data-price="130">
<div>
<div class="game-icon">⚔️</div>
<h3 data-lang-text="Clash of Clans|Clash of Clans">Clash of Clans</h3>
<p data-lang-text="Гемы, аккаунты, прокачка|Gems, accounts, boosting">Гемы, аккаунты, прокачка</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 130₽</span>
</div>
<button class="btn" onclick="buyProduct('Clash of Clans', 130)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-clashroyale" data-price="140">
<div>
<div class="game-icon">👑</div>
<h3 data-lang-text="Clash Royale|Clash Royale">Clash Royale</h3>
<p data-lang-text="Гемы, карты, сундуки|Gems, cards, chests">Гемы, карты, сундуки</p>
</div>
<div>
<div class="game-price">
<span class="price-display">140₽</span>
</div>
<button class="btn" onclick="buyProduct('Clash Royale', 140)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-csgo" data-price="200">
<div>
<div class="game-icon">🔫</div>
<h3 data-lang-text="CS:GO|CS:GO">CS:GO</h3>
<p data-lang-text="Скины, аккаунты, буст рейтинга|Skins, accounts, rank boost">Скины, аккаунты, буст рейтинга</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 200₽</span>
</div>
<button class="btn" onclick="buyProduct('CS:GO', 200)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-dota" data-price="220">
<div>
<div class="game-icon">⚔️</div>
<h3 data-lang-text="Dota 2|Dota 2">Dota 2</h3>
<p data-lang-text="Аркан, батл-пасс, косметика|Arcanas, battle pass, cosmetics">Аркан, батл-пасс, косметика</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 220₽</span>
</div>
<button class="btn" onclick="buyProduct('Dota 2', 220)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-fallguys" data-price="90">
<div>
<div class="game-icon">🤸</div>
<h3 data-lang-text="Fall Guys|Fall Guys">Fall Guys</h3>
<p data-lang-text="Show-Bucks, костюмы, фейм-пасс|Show-Bucks, costumes, fame pass">Show-Bucks, костюмы, фейм-пасс</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 90₽</span>
</div>
<button class="btn" onclick="buyProduct('Fall Guys', 90)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-fortnite" data-price="250">
<div>
<div class="game-icon">🏆</div>
<h3 data-lang-text="Fortnite|Fortnite">Fortnite</h3>
<p data-lang-text="V-Bucks, батл-пасс, эксклюзивные скины|V-Bucks, battle pass, exclusive skins">V-Bucks, батл-пасс, эксклюзивные скины</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 250₽</span>
</div>
<button class="btn" onclick="buyProduct('Fortnite', 250)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-genshin" data-price="100">
<div>
<div class="game-icon">⚡</div>
<h3 data-lang-text="Genshin Impact|Genshin Impact">Genshin Impact</h3>
<p data-lang-text="Примогемы, аккаунты с персонажами|Primogems, character accounts">Примогемы, аккаунты с персонажами</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 100₽</span>
</div>
<button class="btn" onclick="buyProduct('Genshin Impact', 100)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-lol" data-price="200">
<div>
<div class="game-icon">🏆</div>
<h3 data-lang-text="League of Legends|League of Legends">League of Legends</h3>
<p data-lang-text="RP, скины, буст рейтинга|RP, skins, rank boosting">RP, скины, буст рейтинга</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 200₽</span>
</div>
<button class="btn" onclick="buyProduct('League of Legends', 200)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-minecraft" data-price="50">
<div>
<div class="game-icon">⚔️</div>
<h3 data-lang-text="Minecraft|Minecraft">Minecraft</h3>
<p data-lang-text="Аккаунты, донат на сервера, привилегии|Accounts, server donations, perks">Аккаунты, донат на сервера, привилегии</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 50₽</span>
</div>
<button class="btn" onclick="buyProduct('Minecraft', 50)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-overwatch" data-price="150">
<div>
<div class="game-icon">🎮</div>
<h3 data-lang-text="Overwatch 2|Overwatch 2">Overwatch 2</h3>
<p data-lang-text="Монеты, скины, премиум|Coins, skins, premium">Монеты, скины, премиум</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 150₽</span>
</div>
<button class="btn" onclick="buyProduct('Overwatch 2', 150)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-pubg" data-price="160">
<div>
<div class="game-icon">🎯</div>
<h3 data-lang-text="PUBG|PUBG">PUBG</h3>
<p data-lang-text="UC, скины оружия, королевский пасс|UC, weapon skins, royale pass">UC, скины оружия, королевский пасс</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 160₽</span>
</div>
<button class="btn" onclick="buyProduct('PUBG', 160)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-r6" data-price="240">
<div>
<div class="game-icon">⚡</div>
<h3 data-lang-text="Rainbow Six Siege|Rainbow Six Siege">Rainbow Six Siege</h3>
<p data-lang-text="R6 Credits, операторы, косметика|R6 Credits, operators, cosmetics">R6 Credits, операторы, косметика</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 240₽</span>
</div>
<button class="btn" onclick="buyProduct('Rainbow Six Siege', 240)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-roblox" data-price="150">
<div>
<div class="game-icon">🎮</div>
<h3 data-lang-text="Roblox|Roblox">Roblox</h3>
<p data-lang-text="Robux, игровые валюты, премиум|Robux, game currency, premium">Robux, игровые валюты, премиум</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 150₽</span>
</div>
<button class="btn" onclick="buyProduct('Roblox', 150)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-rocket" data-price="120">
<div>
<div class="game-icon">🚗</div>
<h3 data-lang-text="Rocket League|Rocket League">Rocket League</h3>
<p data-lang-text="Credits, машины, декали, ракетный пасс|Credits, cars, decals, rocket pass">Credits, машины, декали, ракетный пасс</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 120₽</span>
</div>
<button class="btn" onclick="buyProduct('Rocket League', 120)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-steam" data-price="100">
<div>
<div class="game-icon">🎮</div>
<h3 data-lang-text="Steam|Steam">Steam</h3>
<p data-lang-text="Пополнение кошелька, игры, подарки|Wallet top-up, games, gifts">Пополнение кошелька, игры, подарки</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 100₽</span>
</div>
<button class="btn" onclick="buyProduct('Steam', 100)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-telegram" data-price="80">
<div>
<div class="game-icon">⭐</div>
<h3 data-lang-text="Telegram Stars|Telegram Stars">Telegram Stars</h3>
<p data-lang-text="Звезды для донатов и подписок|Stars for donations and subscriptions">Звезды для донатов и подписок</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 80₽</span>
</div>
<button class="btn" onclick="buyProduct('Telegram Stars', 80)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

<div class="game-card card-valorant" data-price="300">
<div>
<div class="game-icon">🎯</div>
<h3 data-lang-text="Valorant|Valorant">Valorant</h3>
<p data-lang-text="VP очки, скины оружия, прокачка|VP points, weapon skins, boosting">VP очки, скины оружия, прокачка</p>
</div>
<div>
<div class="game-price">
<span class="price-display">ОТ 300₽</span>
</div>
<button class="btn" onclick="buyProduct('Valorant', 300)" data-lang-text="Купить|Buy">Купить</button>
</div>
</div>

</div>
</div>

<div class="container">
<div class="footer" id="contact">
<h3 data-lang-text="Связаться со мной|Contact Me">Связаться со мной</h3>
<p data-lang-text="Есть вопросы? Пиши в Telegram или на Email!|Questions? DM on Telegram or Email!">Есть вопросы? Пиши в Telegram или на Email!</p>
<div class="contact">
<a href="https://t.me/lowv1rre" target="_blank">📱 @lowv1rre</a>
<a href="mailto:lowv1re1@gmail.com">📧 lowv1re1@gmail.com</a>
</div>
<p style="margin-top:30px;color:var(--text-secondary);font-size:14px;">© 2024 LOWV1RE. Все права защищены.</p>
</div>
</div>

<div class="modal" id="loginModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('loginModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Вход в аккаунт|Login">Вход в аккаунт</h2>
<div id="loginError"></div>
<div class="form-group">
<label data-lang-text="Email или никнейм|Email or username">Email или никнейм</label>
<input type="text" id="loginEmail" placeholder="your@email.com или username" autocomplete="off">
<div id="loginEmailError"></div>
</div>
<div class="form-group">
<label data-lang-text="Пароль|Password">Пароль</label>
<input type="password" id="loginPassword" placeholder="••••••••" autocomplete="new-password">
</div>
<button class="form-submit" onclick="login()" data-lang-text="Войти|Login">Войти</button>

<div class="divider" data-lang-text="или|or">или</div>

<button class="google-btn" onclick="loginWithGoogle()">
<svg class="google-icon" viewBox="0 0 24 24">
<path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
<path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
<path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
<path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
</svg>
<span data-lang-text="Войти через Google|Sign in with Google">Войти через Google</span>
</button>

<div class="form-switch">
<span data-lang-text="Нет аккаунта?|Don't have an account?">Нет аккаунта?</span>
<a onclick="switchModal('loginModal', 'registerModal')" data-lang-text="Регистрация|Register">Регистрация</a>
</div>
<div class="form-switch" style="margin-top:10px;">
<a onclick="switchModal('loginModal', 'forgotModal')" data-lang-text="Забыли пароль или имя?|Forgot password or username?">Забыли пароль или имя?</a>
</div>
</div>
</div>

<div class="modal" id="registerModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('registerModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Регистрация|Registration">Регистрация</h2>
<div id="registerError"></div>
<div class="form-group">
<label data-lang-text="Имя пользователя|Username">Имя пользователя</label>
<input type="text" id="registerUsername" placeholder="username" autocomplete="off" oninput="validateUsernameInput(this)">
<div id="usernameError"></div>
</div>
<div class="form-group">
<label data-lang-text="Email|Email">Email</label>
<input type="email" id="registerEmail" placeholder="your@email.com" autocomplete="off" oninput="validateEmailInput(this, 'emailError')">
<div id="emailError"></div>
</div>
<div class="form-group">
<label data-lang-text="Пароль|Password">Пароль</label>
<input type="password" id="registerPassword" placeholder="••••••••" autocomplete="new-password">
</div>
<button class="form-submit" id="registerBtn" onclick="register()" data-lang-text="Зарегистрироваться|Register">Зарегистрироваться</button>
<div class="form-switch">
<span data-lang-text="Уже есть аккаунт?|Already have an account?">Уже есть аккаунт?</span>
<a onclick="switchModal('registerModal', 'loginModal')" data-lang-text="Войти|Login">Войти</a>
</div>
</div>
</div>

<div class="modal" id="verifyEmailModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('verifyEmailModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Подтверждение регистрации|Registration Confirmation">Подтверждение регистрации</h2>
<div id="verifyError"></div>
<p style="text-align:center;color:#aaa;margin-bottom:20px;" data-lang-text="🎃 Введите код, отправленный на вашу почту, чтобы завершить регистрацию.|🎃 Enter the code sent to your email to complete registration.">🎃 Введите код, отправленный на вашу почту, чтобы завершить регистрацию.</p>
<div class="form-group">
<label data-lang-text="Код подтверждения (6 цифр)|Verification code (6 digits)">Код подтверждения (6 цифр)</label>
<input type="text" id="verifyCode" placeholder="000000" maxlength="6" style="text-align:center;font-size:24px;letter-spacing:5px;">
</div>
<button class="form-submit" id="verifyBtn" onclick="verifyEmailCode()" data-lang-text="Подтвердить|Verify">Подтвердить</button>
<div class="form-switch" style="margin-top:15px;">
<a onclick="resendVerificationCode()" data-lang-text="Отправить код повторно|Resend code">Отправить код повторно</a>
</div>
</div>
</div>

<div class="modal" id="forgotModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('forgotModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Восстановление пароля|Password Recovery">Восстановление пароля</h2>
<p style="color:var(--text-secondary);margin-bottom:24px;text-align:center;" data-lang-text="Введите email для получения кода восстановления|Enter email to receive recovery code">Введите email для получения кода восстановления</p>
<div id="forgotError"></div>
<div class="form-group">
<label data-lang-text="Ваш Email|Your Email">Ваш Email</label>
<input type="email" id="forgotEmail" placeholder="your@email.com" autocomplete="off" oninput="validateEmailInput(this, 'forgotEmailError')">
<div id="forgotEmailError"></div>
</div>
<button class="form-submit" id="forgotBtn" onclick="sendRecovery()" data-lang-text="Отправить код|Send code">Отправить код</button>
<div class="form-switch">
<a onclick="switchModal('forgotModal', 'loginModal')" data-lang-text="Назад ко входу|Back to login">Назад ко входу</a>
</div>
</div>
</div>

<div class="modal" id="resetModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('resetModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Сброс пароля|Password Reset">Сброс пароля</h2>
<div id="resetError"></div>
<p style="text-align:center;color:#aaa;margin-bottom:20px;" data-lang-text="💀 Введите код, чтобы сбросить пароль.|💀 Enter the code to reset your password.">💀 Введите код, чтобы сбросить пароль.</p>
<div class="form-group">
<label data-lang-text="Код из письма (6 цифр)|Code from email (6 digits)">Код из письма (6 цифр)</label>
<input type="text" id="resetCode" placeholder="000000" maxlength="6" style="text-align:center;font-size:24px;letter-spacing:5px;">
</div>
<button class="form-submit" id="resetBtn" onclick="verifyCode()" data-lang-text="Проверить код|Verify code">Проверить код</button>
<div class="form-switch" style="margin-top:15px;">
<a onclick="resendCode()" data-lang-text="Отправить код повторно|Resend code">Отправить код повторно</a>
</div>
</div>
</div>

<div class="modal" id="newPasswordModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('newPasswordModal')">&times;</span>
<h2 class="modal-title" data-lang-text="Новый пароль|New password">Новый пароль</h2>
<div id="newPasswordError"></div>
<div class="form-group">
<label data-lang-text="Новый пароль|New password">Новый пароль</label>
<input type="password" id="newPassword" placeholder="••••••••" autocomplete="new-password">
</div>
<div class="form-group">
<label data-lang-text="Повторите пароль|Repeat password">Повторите пароль</label>
<input type="password" id="newPasswordConfirm" placeholder="••••••••" autocomplete="new-password">
</div>
<button class="form-submit" id="newPasswordBtn" onclick="saveNewPassword()" data-lang-text="Сохранить пароль|Save password">Сохранить пароль</button>
</div>
</div>

<script>
const SUPABASE_URL = 'https://nbelgmhtxjjlfpqmkqbl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZWxnbWh0eGpqbGZwcW1rcWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDg2OTcsImV4cCI6MjA3NzQyNDY5N30.6snueQkGb7LorM_qhVNHdxUOC90FypoVzxllniwn70Q';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;
let currentLang = 'ru';
let recoveryEmail = '';
let verifiedCode = '';
let pendingRegistration = null;
let currentCurrency = 'RUB';
let currentTheme = 'dark';

// Курсы валют (примерные)
const currencyRates = {
    RUB: 1,
    USD: 0.011,
    EUR: 0.010
};

const currencySymbols = {
    RUB: '₽',
    USD: '$',
    EUR: '€'
};

// Отправка email через Edge Function
async function sendEmailCode(email, code, type = 'registration') {
    try {
        const response = await fetch('https://nbelgmhtxjjlfpqmkqbl.supabase.co/functions/v1/send-recovery-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({
                email: email,
                code: code
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            console.error('Edge Function error:', error);
            return false;
        }
        
        const data = await response.json();
        console.log('✅ Email успешно отправлен через Edge Function!', data);
        return true;
    } catch (error) {
        console.error('❌ Ошибка вызова Edge Function:', error);
        return false;
    }
}

// Генерация 6-значного кода (000001-999999)
function generateCode() {
    const code = Math.floor(Math.random() * 999999) + 1;
    return code.toString().padStart(6, '0');
}

// Валидация email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Валидация username (только английские буквы и цифры)
function isValidUsername(username) {
    const usernameRegex = /^[a-zA-Z0-9]+$/;
    return usernameRegex.test(username);
}

// Проверка username в реальном времени
function validateUsernameInput(input) {
    const value = input.value;
    const errorDiv = document.getElementById('usernameError');
    
    if (value && !isValidUsername(value)) {
        input.style.borderColor = '#ff4444';
        input.style.boxShadow = '0 0 10px rgba(255, 68, 68, 0.5)';
        errorDiv.innerHTML = '<div class="error-msg" style="margin-top:5px;">Username может содержать только английские буквы (a-z) и цифры (0-9)</div>';
    } else {
        input.style.borderColor = 'rgba(255,140,0,0.4)';
        input.style.boxShadow = 'none';
        errorDiv.innerHTML = '';
    }
}

// Проверка email в реальном времени
function validateEmailInput(input, errorDivId) {
    const value = input.value.trim();
    const errorDiv = document.getElementById(errorDivId);
    
    if (value && !isValidEmail(value)) {
        input.style.borderColor = '#ff4444';
        input.style.boxShadow = '0 0 10px rgba(255, 68, 68, 0.5)';
        if (!errorDiv.querySelector('.error-msg')) {
            errorDiv.innerHTML = '<div class="error-msg" style="margin-top:5px;">Введите корректный email (например: name@example.com)</div>';
        }
    } else {
        input.style.borderColor = 'rgba(255,140,0,0.4)';
        input.style.boxShadow = 'none';
        if (errorDiv.querySelector('.error-msg') && errorDiv.textContent.includes('email')) {
            errorDiv.innerHTML = '';
        }
    }
}

// Очистка формы
function clearForm(formId) {
    const inputs = document.querySelectorAll(`#${formId} input`);
    inputs.forEach(input => input.value = '');
}

// Очистка сообщений об ошибках
function clearMessages(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = '';
    }
}

// Функция для обновления баланса с учетом валюты
function updateBalance() {
    if (!currentUser) return;
    const balance = currentUser.balance * currencyRates[currentCurrency];
    const symbol = currencySymbols[currentCurrency];
    const formattedBalance = currentCurrency === 'RUB' ? 
        `${Math.round(balance)}${symbol}` : 
        `${symbol}${balance.toFixed(2)}`;
    document.getElementById('profileBalance').textContent = formattedBalance;
}

// Функция для переключения валюты
function changeCurrency() {
    const select = document.getElementById('currencySwitch');
    currentCurrency = select.value;
    localStorage.setItem('currency', currentCurrency);
    
    // Обновляем баланс в профиле
    updateBalance();
    
    // Обновляем все цены на странице
    updateAllPrices();
}

// Функция для обновления всех цен на странице
function updateAllPrices() {
    const gameCards = document.querySelectorAll('.game-card[data-price]');
    const fromText = currentLang === 'ru' ? 'ОТ ' : 'FROM ';
    
    gameCards.forEach(card => {
        const basePrice = parseInt(card.getAttribute('data-price'));
        const priceDisplay = card.querySelector('.price-display');
        
        if (priceDisplay && basePrice) {
            const convertedPrice = basePrice * currencyRates[currentCurrency];
            const symbol = currencySymbols[currentCurrency];
            
            const priceText = currentCurrency === 'RUB' ? 
                `${Math.round(convertedPrice)}${symbol}` : 
                `${symbol}${convertedPrice.toFixed(1)}`;
            
            priceDisplay.textContent = fromText + priceText;
        }
    });
}

// Мобильное меню
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    const overlay = document.getElementById('mobileMenuOverlay');
    menu.classList.toggle('active');
    overlay.classList.toggle('active');
    document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
}

function closeMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    const overlay = document.getElementById('mobileMenuOverlay');
    menu.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

// Синхронизация мобильных элементов с desktop
function syncMobileControls() {
    // Синхронизация валюты
    const currencyMobile = document.getElementById('currencySwitchMobile');
    if (currencyMobile) {
        currencyMobile.value = currentCurrency;
    }
    
    // Синхронизация темы
    const themeMobile = document.getElementById('themeToggleMobile');
    if (themeMobile) {
        themeMobile.textContent = currentTheme === 'dark' ? '🌙' : '☀️';
    }
    
    // Синхронизация языка
    const langMobile = document.getElementById('langSwitchMobile');
    if (langMobile) {
        langMobile.textContent = currentLang.toUpperCase();
    }
    
    // Синхронизация authSection
    const authMobile = document.getElementById('authSectionMobile');
    const authDesktop = document.getElementById('authSection');
    if (authMobile && authDesktop) {
        authMobile.innerHTML = authDesktop.innerHTML;
    }
}

// Функция для переключения темы
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.classList.toggle('light-theme');
    localStorage.setItem('theme', currentTheme);
    
    // Обновляем иконку в обоих местах
    const themeIcon = document.getElementById('themeToggle');
    const themeIconMobile = document.getElementById('themeToggleMobile');
    const icon = currentTheme === 'dark' ? '🌙' : '☀️';
    if (themeIcon) themeIcon.textContent = icon;
    if (themeIconMobile) themeIconMobile.textContent = icon;
}

// Функция поиска игр
function searchGames() {
    const searchInput = document.getElementById('gameSearchInput');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const gameCards = document.querySelectorAll('.game-card');
    let visibleCount = 0;
    
    gameCards.forEach(card => {
        const gameName = card.querySelector('h3').textContent.toLowerCase();
        
        // Проверяем совпадение только с НАЧАЛА названия
        if (searchTerm === '' || gameName.startsWith(searchTerm)) {
            card.style.display = 'flex';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Показываем/скрываем сообщение "Ничего не найдено"
    let noResultsMsg = document.getElementById('noResultsMessage');
    
    if (visibleCount === 0 && searchTerm !== '') {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.id = 'noResultsMessage';
            noResultsMsg.className = 'no-results';
            noResultsMsg.innerHTML = `
                <div class="no-results-icon">😢</div>
                <div data-lang-text="Игры не найдены. Попробуйте другой запрос.|No games found. Try another search.">
                    Игры не найдены. Попробуйте другой запрос.
                </div>
            `;
            document.getElementById('gamesGrid').parentElement.appendChild(noResultsMsg);
        }
        noResultsMsg.style.display = 'block';
    } else {
        if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
}

// Загрузка сохраненных настроек
// Геолокация по IP для автоопределения валюты и языка
async function detectLocationAndSetDefaults() {
    // Проверяем, есть ли уже сохраненные настройки
    const savedCurrency = localStorage.getItem('currency');
    const savedLang = localStorage.getItem('language');
    
    // Если настройки уже есть, не переопределяем
    if (savedCurrency && savedLang) {
        return;
    }
    
    try {
        // Используем бесплатный API для определения страны по IP
        const response = await fetch('https://ipapi.co/json/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.log('Не удалось определить геолокацию, используем настройки по умолчанию');
            return;
        }
        
        const data = await response.json();
        const countryCode = data.country_code;
        
        console.log('🌍 Определена страна:', countryCode, data.country_name);
        
        // Определяем валюту и язык по стране
        let detectedCurrency = 'RUB';
        let detectedLang = 'ru';
        
        // Европейские страны (EUR + EN)
        const eurCountries = ['AT', 'BE', 'CY', 'EE', 'FI', 'FR', 'DE', 'GR', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PT', 'SK', 'SI', 'ES'];
        
        // Англоязычные страны (USD + EN)
        const usdCountries = ['US', 'CA', 'GB', 'AU', 'NZ', 'SG', 'HK'];
        
        // СНГ страны (RUB + RU)
        const rubCountries = ['RU', 'BY', 'KZ', 'KG', 'TJ', 'UZ', 'TM', 'AM', 'AZ', 'MD'];
        
        if (eurCountries.includes(countryCode)) {
            detectedCurrency = 'EUR';
            detectedLang = 'en';
            console.log('🇪🇺 Европа → EUR + EN');
        } else if (usdCountries.includes(countryCode)) {
            detectedCurrency = 'USD';
            detectedLang = 'en';
            console.log('🇺🇸 Англоязычная страна → USD + EN');
        } else if (rubCountries.includes(countryCode)) {
            detectedCurrency = 'RUB';
            detectedLang = 'ru';
            console.log('🇷🇺 СНГ → RUB + RU');
        } else {
            // Для остальных стран по умолчанию
            detectedCurrency = 'USD';
            detectedLang = 'en';
            console.log('🌎 Другая страна → USD + EN (по умолчанию)');
        }
        
        // Применяем настройки только если их еще нет
        if (!savedCurrency) {
            currentCurrency = detectedCurrency;
            document.getElementById('currencySwitch').value = detectedCurrency;
            localStorage.setItem('currency', detectedCurrency);
        }
        
        if (!savedLang) {
            currentLang = detectedLang;
            document.getElementById('langSwitch').textContent = detectedLang.toUpperCase();
            localStorage.setItem('language', detectedLang);
        }
        
        console.log('✅ Применены настройки:', detectedCurrency, detectedLang.toUpperCase());
        
    } catch (error) {
        console.log('⚠️ Ошибка геолокации:', error.message);
        console.log('Используем настройки по умолчанию: RUB + RU');
    }
}

function loadSettings() {
    // Загрузка валюты
    const savedCurrency = localStorage.getItem('currency');
    if (savedCurrency) {
        currentCurrency = savedCurrency;
        document.getElementById('currencySwitch').value = savedCurrency;
    }
    
    // Загрузка темы
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        currentTheme = savedTheme;
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('themeToggle').textContent = '☀️';
        }
    }
    
    // Обновляем цены
    updateAllPrices();
    
    // Синхронизируем мобильное меню
    setTimeout(() => syncMobileControls(), 100);
}

window.addEventListener('load', async () => {
    // Сначала определяем локацию
    await detectLocationAndSetDefaults();
    
    // Затем загружаем настройки (они могут переопределить геолокацию)
    loadSettings();
    await checkAuth();
    updateLangText();
    syncMobileControls();
    
    // Добавляем обработчики
    document.getElementById('currencySwitch').addEventListener('change', changeCurrency);
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
});

async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
        const { data: userData } = await supabase.from('users').select('*').eq('email', user.email).maybeSingle();
        if (userData) {
            currentUser = userData;
            showUserProfile();
        } else if (user.app_metadata.provider === 'google') {
            // Google пользователь впервые - создаем аккаунт
            const username = user.email.split('@')[0];
            const { data: newUser, error } = await supabase.from('users').insert([{
                username: username,
                email: user.email,
                is_admin: false,
                balance: 0
            }]).select().single();
            
            if (!error && newUser) {
                currentUser = newUser;
                showUserProfile();
                console.log('✅ Google пользователь создан');
            }
        }
    } else {
        showAuthButton();
    }
}

function showAuthButton() {
    // Очищаем authSection - кнопка входа в центре страницы
    document.getElementById('authSection').innerHTML = '';
    document.getElementById('profileSection').style.display = 'none';
    // Показываем кнопки входа в hero секции
    const heroButtons = document.getElementById('heroButtons');
    if (heroButtons) heroButtons.style.display = 'flex';
    updateLangText();
    syncMobileControls();
}

function showUserProfile() {
    const avatar = currentUser.username.charAt(0).toUpperCase();
    document.getElementById('authSection').innerHTML = `<div class="user-info" onclick="toggleProfile()"><div class="user-avatar">${avatar}</div><div class="user-name">${currentUser.username}</div></div>`;
    document.getElementById('profileAvatar').textContent = avatar;
    document.getElementById('profileUsername').textContent = currentUser.username;
    document.getElementById('profileEmail').textContent = currentUser.email;
    document.getElementById('profileUrl').textContent = `lowv1re.eu/user${currentUser.id}`;
    // Обновляем баланс с учетом текущей валюты
    updateBalance();
    // Скрываем кнопки входа в hero секции
    const heroButtons = document.getElementById('heroButtons');
    if (heroButtons) heroButtons.style.display = 'none';
    const date = new Date(currentUser.created_at);
    document.getElementById('profileDate').textContent = date.toLocaleDateString('ru-RU');
    syncMobileControls();
}

function toggleProfile() {
    const profile = document.getElementById('profileSection');
    const games = document.getElementById('games');
    if (profile.style.display === 'none') {
        profile.style.display = 'block';
        games.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        profile.style.display = 'none';
        games.style.display = 'block';
    }
}

async function register() {
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim().toLowerCase();
    const password = document.getElementById('registerPassword').value;
    const errorDiv = document.getElementById('registerError');
    const btn = document.getElementById('registerBtn');
    
    // Очистка предыдущих сообщений
    errorDiv.innerHTML = '';
    
    // Валидация полей
    if (!username || !email || !password) {
        errorDiv.innerHTML = '<div class="error-msg">Заполните все поля!</div>';
        return;
    }
    
    // Валидация username
    if (!isValidUsername(username)) {
        errorDiv.innerHTML = '<div class="error-msg">Username может содержать только английские буквы (a-z) и цифры (0-9)</div>';
        return;
    }
    
    if (username.length < 3) {
        errorDiv.innerHTML = '<div class="error-msg">Username должен содержать минимум 3 символа</div>';
        return;
    }
    
    // Валидация email
    if (!isValidEmail(email)) {
        errorDiv.innerHTML = '<div class="error-msg">Введите корректный email!</div>';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.innerHTML = '<div class="error-msg">Пароль должен быть минимум 6 символов!</div>';
        return;
    }
    
    // Блокируем кнопку и показываем загрузку
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span><span data-lang-text="Отправка кода...|Sending code...">Отправка кода...</span>';
    
    try {
        // Проверка существования username
        const { data: existingUser } = await supabase
            .from('users')
            .select('username')
            .eq('username', username)
            .maybeSingle();
        
        if (existingUser) {
            errorDiv.innerHTML = '<div class="error-msg">Это имя пользователя уже занято!</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Зарегистрироваться|Register">Зарегистрироваться</span>';
            updateLangText();
            return;
        }
        
        // Проверка существования email
        const { data: existingEmail } = await supabase
            .from('users')
            .select('email')
            .eq('email', email)
            .maybeSingle();
        
        if (existingEmail) {
            errorDiv.innerHTML = '<div class="error-msg">Этот email уже зарегистрирован!</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Зарегистрироваться|Register">Зарегистрироваться</span>';
            updateLangText();
            return;
        }
        
        // Генерируем 6-значный код
        const code = generateCode();
        
        // Удаляем старые коды для этого email
        await supabase.from('recovery_codes').delete().eq('email', email);
        
        // Сохраняем код в БД (используем timestamp для избежания timezone проблем)
        const now = Date.now(); // Текущее время в миллисекундах
        const expiresAt = new Date(now + 10 * 60 * 1000); // +10 минут
        
        console.log('⏰ Создание кода:');
        console.log('   Timestamp сейчас:', now);
        console.log('   Текущее время (UTC):', new Date(now).toISOString());
        console.log('   Истекает (UTC/ISO):', expiresAt.toISOString());
        console.log('   Разница: +10 минут');
        
        const { error: codeError } = await supabase.from('recovery_codes').insert([{
            email: email,
            code: code,
            expires_at: expiresAt.toISOString(),
            used: false
        }]);
        
        if (codeError) throw codeError;
        
        // Временно: показываем код в консоли (для теста)
        console.log('===================');
        console.log('КОД РЕГИСТРАЦИИ:', code);
        console.log('EMAIL:', email);
        console.log('===================');
        
        // Отправляем через Resend API напрямую
        const emailSent = await sendEmailCode(email, code, 'registration');
        
        // Сохраняем данные регистрации
        pendingRegistration = { username, email, password };
        
        // Сразу переключаемся на модалку ввода кода (БЕЗ задержки!)
        closeModal('registerModal');
        openModal('verifyEmailModal');
        document.getElementById('verifyCode').focus();
        
        // Показываем статус отправки УЖЕ в новой модалке
        const verifyErrorDiv = document.getElementById('verifyError');
        if (emailSent) {
            verifyErrorDiv.innerHTML = '<div class="success-msg">✅ Код отправлен на вашу почту!</div>';
        } else {
            verifyErrorDiv.innerHTML = '<div class="success-msg">⚠️ Если код не пришёл - проверьте консоль (F12)</div>';
        }
        
    } catch (error) {
        console.error('Registration error:', error);
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span data-lang-text="Зарегистрироваться|Register">Зарегистрироваться</span>';
        updateLangText();
    }
}

async function verifyEmailCode() {
    const code = document.getElementById('verifyCode').value.trim();
    const errorDiv = document.getElementById('verifyError');
    const btn = document.getElementById('verifyBtn');
    
    errorDiv.innerHTML = '';
    
    if (!code || code.length !== 6) {
        errorDiv.innerHTML = '<div class="error-msg">Введите 6-значный код!</div>';
        return;
    }
    
    if (!pendingRegistration) {
        errorDiv.innerHTML = '<div class="error-msg">Ошибка! Начните регистрацию заново.</div>';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span><span data-lang-text="Проверка...|Verifying...">Проверка...</span>';
    
    try {
        // Проверяем код
        const { data: codeData, error } = await supabase
            .from('recovery_codes')
            .select('*')
            .eq('email', pendingRegistration.email)
            .eq('code', code)
            .eq('used', false)
            .maybeSingle();
        
        if (error || !codeData) {
            errorDiv.innerHTML = '<div class="error-msg">Неверный код!</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Подтвердить|Verify">Подтвердить</span>';
            updateLangText();
            return;
        }
        
        // Проверяем срок (используем UTC timestamp для корректного сравнения)
        const expiresAt = new Date(codeData.expires_at);
        const now = new Date();
        
        console.log('⏰ Проверка времени:');
        console.log('   Сейчас:', now.toISOString());
        console.log('   Истекает:', expiresAt.toISOString());
        console.log('   Разница (минут):', (expiresAt - now) / 60000);
        
        if (now.getTime() > expiresAt.getTime()) {
            errorDiv.innerHTML = '<div class="error-msg">Код истёк! Запросите новый код.</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Подтвердить|Verify">Подтвердить</span>';
            updateLangText();
            return;
        }
        
        errorDiv.innerHTML = '<div class="success-msg">Email подтверждён! Создание аккаунта...</div>';
        
        // Отмечаем код как использованный
        await supabase.from('recovery_codes').update({ used: true }).eq('code', code);
        
        // Создаём аккаунт в Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: pendingRegistration.email,
            password: pendingRegistration.password,
            options: { emailRedirectTo: window.location.origin }
        });
        
        if (authError) throw authError;
        
        // Добавляем в таблицу users
        const { error: dbError } = await supabase.from('users').insert([{
            username: pendingRegistration.username,
            email: pendingRegistration.email,
            is_admin: false,
            balance: 0
        }]);
        
        if (dbError) throw dbError;
        
        // Автоматический вход в аккаунт
        const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
            email: pendingRegistration.email,
            password: pendingRegistration.password
        });
        
        if (loginError) throw loginError;
        
        // Получаем данные пользователя
        const { data: finalUserData } = await supabase
            .from('users')
            .select('*')
            .eq('email', pendingRegistration.email)
            .single();
        
        currentUser = finalUserData;
        
        errorDiv.innerHTML = '<div class="success-msg">✅ Регистрация завершена! Добро пожаловать!</div>';
        
        setTimeout(() => {
            closeModal('verifyEmailModal');
            showUserProfile();
            pendingRegistration = null;
        }, 1500);
        
    } catch (error) {
        console.error('Verification error:', error);
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span data-lang-text="Подтвердить|Verify">Подтвердить</span>';
        updateLangText();
    }
}

async function resendVerificationCode() {
    if (!pendingRegistration) {
        alert('Ошибка! Начните регистрацию заново.');
        return;
    }
    
    const errorDiv = document.getElementById('verifyError');
    errorDiv.innerHTML = '<div class="success-msg">Отправка нового кода...</div>';
    
    const code = generateCode();
    
    try {
        await supabase.from('recovery_codes').delete().eq('email', pendingRegistration.email);
        
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000);
        
        await supabase.from('recovery_codes').insert([{
            email: pendingRegistration.email,
            code: code,
            expires_at: expiresAt.toISOString(),
            used: false
        }]);
        
        console.log('===================');
        console.log('НОВЫЙ КОД:', code);
        console.log('EMAIL:', pendingRegistration.email);
        console.log('===================');
        
        const emailSent = await sendEmailCode(pendingRegistration.email, code, 'registration');
        
        if (emailSent) {
            errorDiv.innerHTML = '<div class="success-msg">✅ Новый код отправлен на почту!</div>';
        } else {
            errorDiv.innerHTML = '<div class="success-msg">⚠️ Новый код в консоли (F12)!</div>';
        }
        
        document.getElementById('verifyCode').value = '';
        document.getElementById('verifyCode').focus();
    } catch (error) {
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    }
}

// Google Auth
async function loginWithGoogle() {
    try {
        const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.origin
            }
        });
        
        if (error) throw error;
        
        console.log('🔐 Google Auth initiated');
        
    } catch (error) {
        console.error('Google Auth Error:', error);
        const errorDiv = document.getElementById('loginError');
        errorDiv.innerHTML = `<div class="error-msg">Ошибка входа через Google: ${error.message}</div>`;
    }
}

async function login() {
    const identifier = document.getElementById('loginEmail').value.trim().toLowerCase();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    errorDiv.innerHTML = '';
    
    if (!identifier || !password) {
        errorDiv.innerHTML = '<div class="error-msg">Заполните все поля!</div>';
        return;
    }
    
    try {
        let email = identifier;
        
        // Проверяем, это email или username
        if (!identifier.includes('@')) {
            // Это username, ищем email в базе
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('email')
                .eq('username', identifier)
                .maybeSingle();
            
            if (userError || !userData) {
                errorDiv.innerHTML = '<div class="error-msg">Пользователь не найден!</div>';
                return;
            }
            
            email = userData.email;
        }
        
        // Входим через Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email: email, 
            password: password
        });
        
        if (authError) {
            errorDiv.innerHTML = '<div class="error-msg">Неверный логин или пароль!</div>';
            return;
        }
        
        // Получаем данные пользователя из базы
        const { data: userData, error: dbError } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .maybeSingle();
        
        if (!userData) {
            errorDiv.innerHTML = '<div class="error-msg">Пользователь не найден в базе!</div>';
            return;
        }
        
        currentUser = userData;
        closeModal('loginModal');
        showUserProfile();
        updateLangText();
    } catch (error) {
        errorDiv.innerHTML = '<div class="error-msg">Ошибка входа! Попробуйте снова.</div>';
        console.error(error);
    }
}

async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    showAuthButton();
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('games').style.display = 'block';
}

async function buyProduct(productName, price) {
    if (!currentUser) {
        openModal('loginModal');
        return;
    }
    if (currentUser.balance < price) {
        alert(currentLang === 'ru' ? 'Недостаточно средств на балансе!' : 'Insufficient balance!');
        return;
    }
    try {
        const { data: product } = await supabase
            .from('products')
            .select('id')
            .eq('name', productName)
            .maybeSingle();
        
        if (!product) {
            alert(currentLang === 'ru' ? 'Товар не найден!' : 'Product not found!');
            return;
        }
        
        const { error: orderError } = await supabase
            .from('orders')
            .insert([{
                user_id: currentUser.id, 
                product_id: product.id, 
                amount: price, 
                status: 'pending'
            }]);
        
        if (orderError) throw orderError;
        
        const newBalance = currentUser.balance - price;
        const { error: balanceError } = await supabase
            .from('users')
            .update({ balance: newBalance })
            .eq('id', currentUser.id);
        
        if (balanceError) throw balanceError;
        
        currentUser.balance = newBalance;
        document.getElementById('profileBalance').textContent = `${newBalance}₽`;
        
        alert(currentLang === 'ru' 
            ? `Товар "${productName}" куплен! Свяжитесь с @lowv1rre для получения.` 
            : `Product "${productName}" purchased! Contact @lowv1rre to receive.`);
    } catch (error) {
        alert(currentLang === 'ru' ? 'Ошибка при покупке!' : 'Purchase error!');
        console.error(error);
    }
}

function openModal(modalId) { 
    clearMessages(modalId.replace('Modal', 'Error'));
    document.getElementById(modalId).classList.add('active'); 
}

function closeModal(modalId) { 
    document.getElementById(modalId).classList.remove('active');
    // Очищаем форму при закрытии
    clearForm(modalId);
    clearMessages(modalId.replace('Modal', 'Error'));
}

function switchModal(from, to) { 
    closeModal(from); 
    openModal(to); 
}

async function sendRecovery() {
    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
    const errorDiv = document.getElementById('forgotError');
    const btn = document.getElementById('forgotBtn');
    
    errorDiv.innerHTML = '';
    
    if (!email) {
        errorDiv.innerHTML = '<div class="error-msg">Введите email!</div>';
        return;
    }
    
    if (!isValidEmail(email)) {
        errorDiv.innerHTML = '<div class="error-msg">Введите корректный email!</div>';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span><span data-lang-text="Отправка...|Sending...">Отправка...</span>';
    
    try {
        // Проверяем, существует ли пользователь с таким email
        const { data: userData } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .maybeSingle();
        
        if (!userData) {
            errorDiv.innerHTML = '<div class="error-msg">Пользователь с таким email не найден!</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Отправить код|Send code">Отправить код</span>';
            updateLangText();
            return;
        }
        
        // Генерируем 6-значный код
        const code = generateCode();
        
        // Удаляем старые коды для этого email
        await supabase.from('recovery_codes').delete().eq('email', email);
        
        // Создаем новый код (истекает через 10 минут)
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000);
        
        await supabase.from('recovery_codes').insert([{
            email: email,
            code: code,
            expires_at: expiresAt.toISOString(),
            used: false
        }]);
        
        console.log('===================');
        console.log('КОД ВОССТАНОВЛЕНИЯ:', code);
        console.log('EMAIL:', email);
        console.log('ИСТЕКАЕТ:', expiresAt.toISOString());
        console.log('===================');
        
        // Отправляем код через Edge Function
        const emailSent = await sendEmailCode(email, code, 'recovery');
        
        // Сохраняем email для следующего шага
        recoveryEmail = email;
        
        if (emailSent) {
            errorDiv.innerHTML = '<div class="success-msg">✅ Код отправлен на почту! Переход к вводу кода...</div>';
        } else {
            errorDiv.innerHTML = '<div class="success-msg">⚠️ Код в консоли (F12)! Переход к вводу кода...</div>';
        }
        
        // Переключаемся на модалку ввода кода
        setTimeout(() => {
            closeModal('forgotModal');
            openModal('resetModal');
            document.getElementById('resetCode').focus();
        }, 1500);
        
    } catch (error) {
        console.error('Recovery error:', error);
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span data-lang-text="Отправить код|Send code">Отправить код</span>';
        updateLangText();
    }
}

async function verifyCode() {
    const code = document.getElementById('resetCode').value.trim();
    const errorDiv = document.getElementById('resetError');
    const btn = document.getElementById('resetBtn');
    
    errorDiv.innerHTML = '';
    
    if (!code || code.length !== 6) {
        errorDiv.innerHTML = '<div class="error-msg">Введите 6-значный код!</div>';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span><span data-lang-text="Проверка...|Verifying...">Проверка...</span>';
    
    try {
        const { data: codeData, error } = await supabase
            .from('recovery_codes')
            .select('*')
            .eq('email', recoveryEmail)
            .eq('code', code)
            .eq('used', false)
            .maybeSingle();
        
        if (error || !codeData) {
            errorDiv.innerHTML = '<div class="error-msg">Неверный код!</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Проверить код|Verify code">Проверить код</span>';
            updateLangText();
            return;
        }
        
        const expiresAt = new Date(codeData.expires_at);
        const now = new Date();
        
        console.log('⏰ Проверка времени восстановления:');
        console.log('   Сейчас:', now.toISOString());
        console.log('   Истекает:', expiresAt.toISOString());
        console.log('   Разница (минут):', (expiresAt - now) / 60000);
        
        if (now.getTime() > expiresAt.getTime()) {
            errorDiv.innerHTML = '<div class="error-msg">Код истёк! Запросите новый.</div>';
            btn.disabled = false;
            btn.innerHTML = '<span data-lang-text="Проверить код|Verify code">Проверить код</span>';
            updateLangText();
            return;
        }
        
        verifiedCode = code;
        errorDiv.innerHTML = '<div class="success-msg">Код верен!</div>';
        
        setTimeout(() => {
            closeModal('resetModal');
            openModal('newPasswordModal');
            document.getElementById('newPassword').focus();
        }, 1000);
        
    } catch (error) {
        console.error('Code verification error:', error);
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span data-lang-text="Проверить код|Verify code">Проверить код</span>';
        updateLangText();
    }
}

async function resendCode() {
    if (!recoveryEmail) {
        alert('Ошибка! Начните восстановление заново.');
        return;
    }
    
    const errorDiv = document.getElementById('resetError');
    errorDiv.innerHTML = '<div class="success-msg">Отправка нового кода...</div>';
    
    const code = generateCode();
    
    try {
        await supabase.from('recovery_codes').delete().eq('email', recoveryEmail);
        
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000);
        
        await supabase.from('recovery_codes').insert([{
            email: recoveryEmail,
            code: code,
            expires_at: expiresAt.toISOString(),
            used: false
        }]);
        
        console.log('===================');
        console.log('НОВЫЙ КОД ВОССТАНОВЛЕНИЯ:', code);
        console.log('EMAIL:', recoveryEmail);
        console.log('===================');
        
        const emailSent = await sendEmailCode(recoveryEmail, code, 'recovery');
        
        if (emailSent) {
            errorDiv.innerHTML = '<div class="success-msg">✅ Новый код отправлен!</div>';
        } else {
            errorDiv.innerHTML = '<div class="success-msg">⚠️ Новый код в консоли (F12)!</div>';
        }
        
        document.getElementById('resetCode').value = '';
        document.getElementById('resetCode').focus();
    } catch (error) {
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    }
}

async function saveNewPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('newPasswordConfirm').value;
    const errorDiv = document.getElementById('newPasswordError');
    const btn = document.getElementById('newPasswordBtn');
    
    errorDiv.innerHTML = '';
    
    if (!newPassword || !confirmPassword) {
        errorDiv.innerHTML = '<div class="error-msg">Заполните все поля!</div>';
        return;
    }
    
    if (newPassword !== confirmPassword) {
        errorDiv.innerHTML = '<div class="error-msg">Пароли не совпадают!</div>';
        return;
    }
    
    if (newPassword.length < 6) {
        errorDiv.innerHTML = '<div class="error-msg">Пароль должен быть минимум 6 символов!</div>';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span><span data-lang-text="Сохранение...|Saving...">Сохранение...</span>';
    
    try {
        console.log('🔄 Обновление пароля для:', recoveryEmail);
        
        // Отмечаем код как использованный
        await supabase
            .from('recovery_codes')
            .update({ used: true })
            .eq('code', verifiedCode);
        
        // Вызываем Edge Function для сброса пароля
        const response = await fetch('https://nbelgmhtxjjlfpqmkqbl.supabase.co/functions/v1/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({
                email: recoveryEmail,
                newPassword: newPassword
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || data.error) {
            throw new Error(data.error || 'Ошибка обновления пароля');
        }
        
        console.log('✅ Пароль успешно обновлён через Edge Function!');
        
        errorDiv.innerHTML = '<div class="success-msg">💥 Пароль успешно изменён. Теперь вы можете войти.</div>';
        
        setTimeout(() => {
            closeModal('newPasswordModal');
            openModal('loginModal');
            document.getElementById('loginEmail').value = recoveryEmail;
            document.getElementById('loginPassword').focus();
            recoveryEmail = '';
            verifiedCode = '';
        }, 2500);
        
    } catch (error) {
        console.error('❌ Ошибка сброса пароля:', error);
        errorDiv.innerHTML = `<div class="error-msg">Ошибка: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span data-lang-text="Сохранить пароль|Save password">Сохранить пароль</span>';
        updateLangText();
    }
}

const langSwitch = document.getElementById('langSwitch');
langSwitch.addEventListener('click', () => {
    currentLang = currentLang === 'ru' ? 'en' : 'ru';
    langSwitch.textContent = currentLang.toUpperCase();
    const langSwitchMobile = document.getElementById('langSwitchMobile');
    if (langSwitchMobile) langSwitchMobile.textContent = currentLang.toUpperCase();
    updateLangText();
});

// Обработчик для мобильного переключателя языка
const langSwitchMobile = document.getElementById('langSwitchMobile');
if (langSwitchMobile) {
    langSwitchMobile.addEventListener('click', () => {
        currentLang = currentLang === 'ru' ? 'en' : 'ru';
        langSwitch.textContent = currentLang.toUpperCase();
        langSwitchMobile.textContent = currentLang.toUpperCase();
        updateLangText();
    });
}

function updateLangText() {
    document.querySelectorAll('[data-lang-text]').forEach(el => {
        const texts = el.dataset.langText.split('|');
        if (el.tagName === 'OPTION') {
            el.textContent = currentLang === 'ru' ? texts[0] : texts[1];
        } else {
            el.innerHTML = currentLang === 'ru' ? texts[0] : texts[1];
        }
    });
    
    // Обработка placeholder'ов
    document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
        const texts = el.dataset.langPlaceholder.split('|');
        el.placeholder = currentLang === 'ru' ? texts[0] : texts[1];
    });
    
    // Обновляем цены для перевода "ОТ"/"FROM"
    updateAllPrices();
}

let lastScroll = 0;
const header = document.getElementById('header');
const HEADER_HIDE_POINT = 150;

window.addEventListener('scroll', () => {
    const currentScroll = window.pageYOffset;
    
    if (currentScroll > HEADER_HIDE_POINT) {
        if (currentScroll > lastScroll) {
            header.classList.add('hidden');
        }
    } else {
        header.classList.remove('hidden');
    }
    
    lastScroll = currentScroll;
});
</script>
</body>
</html>
